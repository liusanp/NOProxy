# 构建阶段
FROM golang:1.25-alpine AS builder

WORKDIR /build

COPY backend-go/go.mod backend-go/go.sum ./
RUN go mod download

COPY backend-go/ .
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o server .

# 运行阶段 - 精简版，不含浏览器
FROM alpine:3.19

RUN apk add --no-cache ca-certificates tzdata

WORKDIR /app

COPY --from=builder /build/server .
COPY frontend/dist ./frontend/dist

RUN mkdir -p cache/videos

# 默认使用外部 CDP
ENV BROWSER_MODE=cdp
ENV CDP_URL=http://host.docker.internal:9222

EXPOSE 8000

CMD ["/app/server"]
